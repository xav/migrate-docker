version: 2
jobs:
  build:
    docker:
      - image: circleci/golang:1.10

    working_directory: /home/circleci/image-builder
    steps:
      - checkout

      - setup_remote_docker:
          docker_layer_caching: true

      - run:
          name: Fetch dependencies
          command: |
            go get github.com/lib/pq
            go get github.com/go-sql-driver/mysql
            go get github.com/gocql/gocql

      - run:
          name: Build image
          command: |
            go get github.com/mattes/migrate/cli
            CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags "-s" -a -installsuffix cgo -tags 'postgres cassandra redshift mysql aws-s3' -o migrate github.com/mattes/migrate/cli

      - run:
          name: Publish image
          command: |
            docker login -u $DOCKER_USER -p $DOCKER_PASS
            docker build -f Dockerfile -t xbasty/migrate:$CIRCLE_SHA1 .
            docker push xbasty/migrate
